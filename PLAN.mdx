# Make Data Model City-Agnostic (Issue #2)

## Objective
Make the backend and data model city-aware while keeping the UI unchanged. This prevents costly retrofitting later while maintaining the current Bengaluru-focused user experience.

## Checkpoints

### 1. Database Schema Changes
Add `city` column to relevant tables with default values:
- **maps table**: Add `city VARCHAR(100) DEFAULT 'Bangalore' NOT NULL`
- **locations table**: Add `city VARCHAR(100) DEFAULT 'Bangalore' NOT NULL`
- **users table**: Add `city VARCHAR(100)` (nullable, for user's preferred city)
- Create indexes on city columns for efficient filtering
- Backfill existing data with 'Bangalore'

### 2. Update TypeScript Types
Add city field to all relevant interfaces:
- `MapData`, `MapResponse`, `MapSchema` in `lib/types/mapTypes.ts`
- `Location` interface in `lib/types/mapTypes.ts`
- `UserSchema`, `User` in `lib/types/userTypes.ts`

### 3. Update Service Layer
Modify service functions to handle city field:
- `lib/supabase/mapsService.ts`: createMap, getMaps, getMapById, getMapBySlug, createLocation
- `lib/supabase/locationService.ts`: getLocationDetails
- `lib/supabase/userService.ts`: upsertUser
- Default all operations to 'Bangalore' for now

### 4. Update RPC Functions
Modify PostgreSQL functions to support optional city filtering:
- `get_maps_sorted_by_upvotes`: Add optional city parameter
- `get_location_counts`: Add city filtering
- `get_contributor_counts`: Add city filtering
- Keep backward compatibility (no city filter = return all)

### 5. Add City Defaulting Logic
Implement city defaulting throughout the app:
- All new map creations default to 'Bangalore'
- All new location submissions default to 'Bangalore'
- User city preference defaults to 'Bangalore'
- Keep UI unchanged (no city selection fields visible)

### 6. Update API Routes
Add city parameter support to API routes:
- `app/api/maps/[slug]/route.ts`
- `app/api/check-slug/route.ts`
- Update sitemap generation in `app/sitemap.ts`
- Keep default behavior to 'Bangalore'

## Implementation Notes
- **No UI changes**: City selection remains hidden until needed
- **Backward compatible**: All existing queries default to 'Bangalore'
- **Future-proof**: Schema ready for multi-city expansion
- **Low cost now**: Simple VARCHAR fields with indexes
- **High cost later avoided**: No need to retrofit constraints, URLs, or filtering

## Success Criteria
- ✅ Database has city columns with appropriate defaults
- ✅ TypeScript types include city fields
- ✅ All service functions handle city parameter
- ✅ RPC functions support city filtering
- ✅ Existing functionality unchanged (all defaults to 'Bangalore')
- ✅ Ready for future multi-city expansion without schema changes
