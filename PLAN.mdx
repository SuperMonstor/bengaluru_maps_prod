
---

# Feature Implementation Plan

## Feature 1: Google Maps List Import Tool

### Objective
Allow users to paste a public Google Maps list URL (e.g., `https://maps.app.goo.gl/Kbtbcuqjmhwmvr5NA`) on the submit page and automatically import all locations from that list into their map.

### Technical Analysis

**Approach: Server-side scraping** (validated)

**URL Resolution Flow:**
1. Short URL (`maps.app.goo.gl/xxx`) → redirects to full URL
2. Full URL contains list ID: `!2s{LIST_ID}` (e.g., `!2sT4aSVQ0UTKaVF_cbxA_Ubg`)
3. Full URL format: `https://www.google.com/maps/@/data=!4m3!11m2!2s{LIST_ID}!3e3`

**Data Available from Scraping:**
- Location names
- Full addresses
- Coordinates (lat/lng)
- Tested with 78-location list - works well

**Import Flow:**
1. User pastes URL → Server resolves short URL
2. Server fetches and parses list page → extracts location data
3. For each location: match with Google Places API → get place_id
4. Bulk create locations using existing logic

### Checkpoints

#### 1.1 Create URL resolution utility
- Create `lib/services/googleMapsListService.ts`
- Function to resolve short URLs (follow redirects)
- Extract list ID from full URL using regex
- Validate URL format (must be Google Maps list)

#### 1.2 Build list scraping/parsing service
- Fetch the Google Maps list page HTML
- Parse embedded JSON/data to extract locations
- Extract for each location: name, address, lat/lng
- Return structured array: `{ name, address, latitude, longitude }[]`
- Handle errors (private list, invalid URL, network issues)

#### 1.3 Create Google Places matching utility
- For each scraped location, search Google Places API by name + coordinates
- Get proper `place_id` and `google_maps_url` for each
- Handle cases where Places API doesn't find a match (use coordinates only)
- Rate limit API calls to avoid quota issues

#### 1.4 Create bulk import server action
- Create `lib/supabase/api/bulkImportLocationsAction.ts`
- Accept array of parsed location data + mapId
- For each location:
  - Check for duplicates (existing logic)
  - Create location with proper fields
  - Auto-approve if user is map owner
- Return summary: `{ imported: number, skipped: number, errors: string[] }`

#### 1.5 Build import UI on submit page
- Add "Import from Google Maps List" tab/section to submit page
- URL input with paste button
- "Fetch Locations" button → shows loading state
- Preview list of locations to import (with checkboxes to deselect)
- Location count display
- "Import All" button → shows progress (X of Y imported)
- Success summary with link to view map

#### 1.6 Testing and edge cases
- Test with small (5), medium (20), large (50+) lists
- Handle private/inaccessible lists with clear error message
- Handle duplicate detection across bulk import
- Test rate limiting with large lists
- Verify imported locations display correctly on map

---

## Feature 2: Add Collaborators

### Objective
Allow map creators to add other users as collaborators who can add and maintain locations on the map. Include email notifications for invitations.

### Technical Analysis

**Current State:**
- Maps have single `owner_id` - only owner can edit
- No collaborator table exists
- Email system (Resend) already in place
- Authorization checks are application-level in server actions

**New Components Needed:**
- `map_collaborators` database table
- Collaborator management UI (invite, remove)
- Updated permission checks across all relevant actions
- Email templates for invitations

### Checkpoints

#### 2.1 Create database schema for collaborators
- Create `map_collaborators` table:
  ```sql
  - id (UUID, primary key)
  - map_id (UUID, FK to maps)
  - user_id (UUID, FK to users, nullable for pending invites)
  - email (string, for pending invites)
  - role ('editor' | 'viewer')
  - status ('pending' | 'accepted' | 'declined')
  - invited_by (UUID, FK to users)
  - created_at, updated_at
  ```
- Add RLS policies for security
- Create TypeScript types in `lib/types/mapTypes.ts`

#### 2.2 Create collaborator service functions
- `addCollaborator(mapId, email, role)` - invite by email
- `removeCollaborator(mapId, collaboratorId)` - remove collaborator
- `getCollaborators(mapId)` - list all collaborators
- `acceptInvitation(invitationId)` - accept invite
- `checkCollaboratorPermission(mapId, userId, permission)` - permission check helper

#### 2.3 Create server actions for collaborator management
- `inviteCollaboratorAction` - sends invite email
- `removeCollaboratorAction` - removes collaborator
- `acceptInvitationAction` - accepts pending invite
- `getCollaboratorsAction` - fetches collaborator list

#### 2.4 Update permission checks across codebase
- Update `updateMapAction` to allow collaborators with edit role
- Update `fetchPendingSubmissionsAction` to allow collaborators
- Update `approveLocationAction` / `rejectLocationAction`
- Update location deletion permissions
- Create shared `hasMapEditPermission(mapId, userId)` helper

#### 2.5 Create email templates for collaborator invitations
- Invitation email template (with accept link)
- Acceptance confirmation email to inviter
- Add to existing `emailService.ts`

#### 2.6 Build collaborator management UI
- Add "Collaborators" section to map edit page
- Email input to invite new collaborators
- List of current collaborators with remove button
- Role selector (editor/viewer)
- Pending invitations display

#### 2.7 Build invitation acceptance flow
- Create `/invitations/[id]/accept` route
- Handle logged-in vs logged-out users
- Link user account to invitation on accept
- Redirect to map after acceptance

#### 2.8 Testing
- Test invitation flow end-to-end
- Verify permission checks work for collaborators
- Test edge cases (invite existing collaborator, remove self, etc.)
- Verify emails are sent correctly

---

## Feature 3: Rename "Contribute" to "Add Location"

### Objective
Replace all instances of "Contribute" with "Add Location" for clearer UX.

### Changes Required

#### 3.1 UI Changes (High Priority)
- `components/map/MapDetailsDialog.tsx:98` - Button "Contribute a Location" → "Add Location"

#### 3.2 Documentation Updates (Low Priority)
- `docs/style-guide.md:314` - Update design reference
- `README.md:14, 17` - Update feature descriptions
- `app/layout.tsx:25` - Update SEO meta description

### Checkpoints

#### 3.1 Update UI text
- Change button label in MapDetailsDialog.tsx
- Search for any other "contribute" text in components

#### 3.2 Update documentation
- Update style-guide.md
- Update README.md
- Update SEO description in layout.tsx

---

## Implementation Order

1. **Feature 3: Rename "Contribute"** - Quick win, 5 minutes
2. **Feature 1: Google Maps Import** - Medium complexity, needs research first
3. **Feature 2: Collaborators** - Highest complexity, database changes

---

## Open Questions

### Feature 1 (Google Maps Import)
- [x] ~~Is scraping Google Maps lists feasible/reliable?~~ **Yes, validated**
- [x] ~~Should we consider KML upload as alternative?~~ **No, not user-friendly**
- [ ] Rate limiting for bulk Places API calls - implement delays between calls

### Feature 2 (Collaborators)
- [ ] Should collaborators be able to invite other collaborators?
- [ ] Do we need a "viewer" role or just "editor"?
- [ ] Should there be a limit on number of collaborators?

