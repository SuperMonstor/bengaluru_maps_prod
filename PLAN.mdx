
---

# Feature Implementation Plan

## Feature 1: Google Maps List Import Tool ✅ COMPLETE

### Objective
Allow users to paste a public Google Maps list URL (e.g., `https://maps.app.goo.gl/Kbtbcuqjmhwmvr5NA`) on the create-map page and automatically import all locations from that list into their map.

### Implementation Summary

**Approach: Server-side scraping with signal-based extraction**

**Key Files:**
- `lib/services/googleMapsListService.ts` - URL resolution, HTML parsing, signal-based extraction
- `lib/supabase/api/bulkImportLocationsAction.ts` - Bulk database insertion with deduplication
- `lib/supabase/api/parseGoogleMapsListAction.ts` - Server action wrapper
- `components/map/GoogleMapsListImport.tsx` - UI component with preview mode

**Architecture:**
1. Find `<script>` tag containing location data (anchored by `/g/` patterns)
2. Extract data array using coordinate pattern anchor `[null,null,LAT,LNG]`
3. Unescape and parse as JavaScript using `Function()`
4. Signal-based recursive walk to extract: name, coords, CID
5. CID used as canonical identifier (no Google Places API needed)
6. Deduplication by CID, URL, and coordinates

**Tested:** 79-location list - extracts all locations correctly

### Checkpoints

#### 1.1 Create URL resolution utility ✅
#### 1.2 Build list scraping/parsing service ✅
#### 1.3 Create Google Places matching utility ⏭️ SKIPPED
- Better approach: Use CID directly from scraping
- CID-based URLs (`https://maps.google.com/?cid={cid}`) are more reliable
- No API calls needed, saves cost/quota

#### 1.4 Create bulk import server action ✅
#### 1.5 Build import UI on create-map page ✅
#### 1.6 Testing and edge cases ✅

---

## Feature 2: Add Collaborators

### Objective
Allow map creators to add collaborators via shareable invite links. Collaborators get full edit access (add locations, approve/reject submissions) without needing approval workflow.

### Technical Analysis

**Current State:**
- Maps have single `owner_id` - only owner can edit
- No collaborator table exists
- Auth callback doesn't support custom redirects after login
- Authorization checks are application-level in server actions

**Approach: Invite Links (not email-based)**
- Owner generates a unique invite link per map
- Shares link via WhatsApp, email, etc. (manual sharing)
- Anyone with link can join as collaborator
- No email system needed for invitations

**New Components Needed:**
- `map_collaborators` table (user_id, map_id, role, joined_at)
- `invite_token` column on maps table
- Invite link generation/regeneration UI
- Updated auth callback to support redirect URLs
- Collaborator acceptance flow with popup

### Checkpoints

#### 2.1 Create database schema
- Add `invite_token` (UUID) column to maps table
- Create `map_collaborators` table:
  ```sql
  - id (UUID, primary key)
  - map_id (UUID, FK to maps)
  - user_id (UUID, FK to users)
  - role ('editor')
  - joined_at (timestamp)
  - UNIQUE(map_id, user_id)
  ```
- Add RLS policies for security
- Create TypeScript types in `lib/types/mapTypes.ts`

#### 2.2 Create invite link service functions
- `generateInviteToken(mapId)` - create/regenerate token
- `getMapByInviteToken(token)` - fetch map for acceptance
- `addCollaborator(mapId, userId)` - add user as collaborator
- `removeCollaborator(mapId, userId)` - remove collaborator
- `getCollaborators(mapId)` - list all collaborators
- `isCollaborator(mapId, userId)` - check if user is collaborator

#### 2.3 Create server actions
- `generateInviteTokenAction` - generates new token
- `acceptInviteAction` - accepts invite for logged-in user
- `removeCollaboratorAction` - removes collaborator
- `getCollaboratorsAction` - fetches collaborator list

#### 2.4 Update auth callback for redirects
- Modify `/app/auth/callback/route.ts`
- Support redirect URL after login (for invite flow)
- Store redirect in cookie before OAuth, read after

#### 2.5 Update permission checks
- Create `hasMapEditPermission(mapId, userId)` helper
- Returns true if owner OR collaborator
- Update: `updateMapAction`, `fetchPendingSubmissionsAction`, `approveLocationAction`, `deleteLocationAction`

#### 2.6 Build invite acceptance flow
- Create `/invite/[token]` route
- If logged in: Show popup "Join [Map Name] as collaborator?" → Accept/Decline
- If not logged in: Redirect to login with return URL, then show popup
- On accept: Add to collaborators, redirect to map
- On decline: Redirect to home

#### 2.7 Build collaborator management UI
- Add "Collaborators" section to map edit page
- Show invite link with copy button
- "Regenerate Link" button (invalidates old link)
- List current collaborators with remove button

#### 2.8 Testing
- Test invite flow (logged in vs logged out)
- Verify permission checks work for collaborators
- Test edge cases (already collaborator, invalid token, owner clicking own link)

---

## Feature 3: Rename "Contribute" to "Suggest Location" ✅ COMPLETE

### Objective
Replace "Contribute" with clearer terminology for better UX.

### Implementation Summary
- Button text changed from "Contribute a Location" to "Suggest Location"
- "Suggest Location" chosen over "Add Location" as it better conveys the submission/approval workflow

### Checkpoints

#### 3.1 Update UI text ✅
- Changed button label in MapDetailsDialog.tsx to "Suggest Location"

#### 3.2 Documentation Updates (Deferred)
- Documentation updates can be done as needed

---

## Implementation Order

1. **Feature 3: Rename "Contribute"** - Quick win, 5 minutes
2. **Feature 1: Google Maps Import** - Medium complexity, needs research first
3. **Feature 2: Collaborators** - Highest complexity, database changes

---

## Open Questions

### Feature 1 (Google Maps Import)
- [x] ~~Is scraping Google Maps lists feasible/reliable?~~ **Yes, validated**
- [x] ~~Should we consider KML upload as alternative?~~ **No, not user-friendly**
- [ ] Rate limiting for bulk Places API calls - implement delays between calls

### Feature 2 (Collaborators)
- [x] ~~Should collaborators be able to invite other collaborators?~~ **No, only owner can share link**
- [x] ~~Do we need a "viewer" role or just "editor"?~~ **Just editor for now**
- [x] ~~Should there be a limit on number of collaborators?~~ **No limit**
- [x] ~~Can collaborators approve/reject submissions?~~ **Yes, full edit access**
- [x] ~~Link expiry?~~ **No expiry, but owner can regenerate to invalidate**

