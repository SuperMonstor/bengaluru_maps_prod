# Auth Refactor Plan: Server-First Architecture

## Goal
Eliminate client-side auth race conditions by moving auth state management to server components and using server actions for mutations.

## Current Problems
- AuthContext fetches user data on client mount (race conditions)
- Client-side session management leads to timing issues
- Profile icon shows blank after sign-in due to async state updates
- Multiple auth state sources causing inconsistency

## Target Architecture
```
Server Component (layout.tsx)
  ↓ Fetches complete user (auth + profile)
  ↓ Passes user as prop
Client Component (Header.tsx)
  ↓ Displays user
  ↓ Handles sign-out via server action
  ↓ Triggers router.refresh() on auth changes
```

---

## Implementation Steps

### Phase 1: Create Server-Side User Fetcher
- [ ] Create new file `lib/auth/getUser.ts` (server-only utility)
- [ ] Implement `getUser()` function that:
  - Gets Supabase session using server client
  - If session exists, queries users table for full profile
  - Returns complete user object or null
  - No retry logic needed (server-side is synchronous)
- [ ] Export type for the return value

### Phase 2: Update Root Layout to Server Component
- [ ] Check current `app/layout.tsx` - verify if it's already a server component
- [ ] If it has `"use client"`, we need to split it:
  - Keep layout as server component
  - Move client-only parts to separate client components
- [ ] In layout, call `await getUser()` at the top level
- [ ] Pass user data to a new `<LayoutClient>` wrapper component

### Phase 3: Create Layout Client Wrapper
- [ ] Create `components/layout/LayoutClient.tsx` as client component
- [ ] Accept `user` as prop (passed from server layout)
- [ ] Create lightweight React Context just for passing user down tree
  - Only stores user object (no loading state, no fetching logic)
  - Just a prop-drilling alternative
- [ ] Render children with context provider

### Phase 4: Update Header Component
- [ ] Remove `useAuth()` hook import from `AuthContext`
- [ ] Import user from new lightweight context instead
- [ ] Remove all loading state handling (server gives complete data)
- [ ] Update sign-out handler to:
  - Call server action
  - Call `router.refresh()` to re-fetch server data
  - Don't do `window.location.href` (let Next.js handle it)
- [ ] Simplify avatar rendering (user is always complete or null)

### Phase 5: Update Other Components Using Auth
- [ ] Find all files importing `useAuth` from old AuthContext:
  - `app/create-map/page.tsx`
  - `app/maps/[slug]/edit/page.tsx`
  - `app/maps/[slug]/submit/page.tsx`
  - `app/maps/[slug]/ClientMapPageComponent.tsx`
  - `app/my-maps/page.tsx`
  - `app/my-maps/[mapId]/pending/page.tsx`
- [ ] For each file, replace with new lightweight context hook
- [ ] Remove `isLoading` checks (not needed anymore)
- [ ] Keep pages as client components if they need interactivity
- [ ] For server components, fetch user directly with `getUser()`

### Phase 6: Update Auth Callback Flow
- [ ] Simplify `app/(auth)/auth/callback/page.tsx`:
  - Remove retry logic (not needed)
  - After successful OAuth exchange, just redirect
  - Server will handle user fetch on next page load
- [ ] Ensure `updateUserInDatabase` is called before redirect
- [ ] Use `router.push('/')` instead of `window.location.href`

### Phase 7: Update Sign-Out Action
- [ ] Check `lib/actions/auth.ts` (or wherever signOutAction lives)
- [ ] Ensure it:
  - Calls Supabase sign out
  - Revalidates path or tag
  - Returns success/error
- [ ] Remove client-side auth state clearing (server handles it)

### Phase 8: Update PendingCountContext
- [ ] Check if `PendingCountContext` depends on old AuthContext
- [ ] If yes, update to use new user context
- [ ] Consider if pending count should be server-fetched too

### Phase 9: Remove Old AuthContext
- [ ] Delete `lib/context/AuthContext.tsx`
- [ ] Remove any remaining imports
- [ ] Clean up any unused auth utilities

### Phase 10: Testing & Cleanup
- [ ] Test sign-in flow:
  - Google OAuth should work smoothly
  - Profile icon should appear immediately
  - No blank avatar state
- [ ] Test sign-out flow:
  - Should clear user state
  - Should redirect to home
  - Should show sign-in button
- [ ] Test protected pages:
  - Create map page
  - Edit map page
  - My maps page
- [ ] Test page navigation (user state persists)
- [ ] Remove any debug logging
- [ ] Update any affected tests

---

## Benefits After Refactor
- ✅ No race conditions (server has full control)
- ✅ Simpler mental model (data flows down from server)
- ✅ Better performance (less client-side code)
- ✅ Easier debugging (server logs are reliable)
- ✅ Works with React Server Components properly
- ✅ Better for SEO (user data available on server)

## Rollback Plan
If issues arise:
1. Keep old AuthContext temporarily
2. Feature flag between old and new system
3. Test incrementally (start with just Header)
4. Can run both systems in parallel during migration

## Notes
- This is a significant refactor but touches fewer files than it seems
- Most components just swap one hook for another
- The core logic simplifies dramatically
- Server Components are the future of Next.js - this aligns with best practices
