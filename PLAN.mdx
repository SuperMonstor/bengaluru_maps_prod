# Make Data Model City-Agnostic (Issue #2)

## Objective
Make the backend and data model city-aware while keeping the UI unchanged. This prevents costly retrofitting later while maintaining the current Bengaluru-focused user experience.

## Checkpoints

### 1. Database Schema Changes
Add `city` column to relevant tables with default values:
- **maps table**: Add `city VARCHAR(100) DEFAULT 'Bangalore' NOT NULL`
- **locations table**: Add `city VARCHAR(100) DEFAULT 'Bangalore' NOT NULL`
- **users table**: Add `city VARCHAR(100)` (nullable, for user's preferred city)
- Create indexes on city columns for efficient filtering
- Backfill existing data with 'Bangalore'

### 2. Update TypeScript Types
Add city field to all relevant interfaces:
- `MapData`, `MapResponse`, `MapSchema` in `lib/types/mapTypes.ts`
- `Location` interface in `lib/types/mapTypes.ts`
- `UserSchema`, `User` in `lib/types/userTypes.ts`

### 3. Update Service Layer
Modify service functions to handle city field:
- `lib/supabase/mapsService.ts`: createMap, getMaps, getMapById, getMapBySlug, createLocation
- `lib/supabase/locationService.ts`: getLocationDetails
- `lib/supabase/userService.ts`: upsertUser
- Default all operations to 'Bangalore' for now

### 4. Update RPC Functions
Modify PostgreSQL functions to support optional city filtering:
- `get_maps_sorted_by_upvotes`: Add optional city parameter
- `get_location_counts`: Add city filtering
- `get_contributor_counts`: Add city filtering
- Keep backward compatibility (no city filter = return all)

### 5. Add City Defaulting Logic
Implement city defaulting throughout the app:
- All new map creations default to 'Bangalore'
- All new location submissions default to 'Bangalore'
- User city preference defaults to 'Bangalore'
- Keep UI unchanged (no city selection fields visible)

### 6. Update API Routes
Add city parameter support to API routes:
- `app/api/maps/[slug]/route.ts`
- `app/api/check-slug/route.ts`
- Update sitemap generation in `app/sitemap.ts`
- Keep default behavior to 'Bangalore'

## Implementation Notes
- **No UI changes**: City selection remains hidden until needed
- **Backward compatible**: All existing queries default to 'Bangalore'
- **Future-proof**: Schema ready for multi-city expansion
- **Low cost now**: Simple VARCHAR fields with indexes
- **High cost later avoided**: No need to retrofit constraints, URLs, or filtering

## Success Criteria
- ✅ Database has city columns with appropriate defaults
- ✅ TypeScript types include city fields
- ✅ All service functions handle city parameter
- ✅ RPC functions support city filtering
- ✅ Existing functionality unchanged (all defaults to 'Bangalore')
- ✅ Ready for future multi-city expansion without schema changes

---

# Add 'Use Current Location' Feature (Issue #6)

## Objective
Enable users to find locations near them by using their current location. Simple one-time coordinate retrieval with distance-based sorting. No persistent tracking or over-engineered location features.

## Rationale
- Primary use case: "Where should I go near me right now?"
- Keep it minimal: Get location → Calculate distances → Sort by proximity
- No live tracking, no persistent permissions

## Implementation Status
- ✅ Global location context integrated
- ✅ Auto-request device location on app load
- ✅ Reverse geocoding for location names
- ✅ Header location indicator (replaces "Request Feature/Fix")
- ✅ Distance-based sorting on map pages
- ✅ User location marker on map
- ⏳ Manual location entry dialog (future enhancement)

## Checkpoints

### 1. Create distance calculation utility
Add Haversine formula utility function:
- Create `/lib/utils/distance.ts`
- Function to calculate great-circle distance between two coordinates
- Returns distance in kilometers
- Pure function, no external dependencies

### 2. Create geolocation hook
Build `useGeolocation` hook for browser API:
- Create `/lib/hooks/useGeolocation.ts`
- Request browser location once (not continuous)
- Handle loading, error, and permission states
- Return coordinates, loading flag, error message, and trigger function

### 3. Add UI button and state management
Integrate "Use Current Location" button:
- Add button to `/app/maps/[slug]/ClientMapPageComponent.tsx`
- Show loading state during geolocation request
- Display error messages if permission denied or unavailable
- Store user coordinates in component state

### 4. Integrate distance sorting
Calculate and sort by proximity:
- When user location is available, calculate distance to each location
- Sort locations array by distance (nearest first)
- Display distance in location list (e.g., "1.2 km away")
- Maintain original sort when user location not active

### 5. Add user location marker
Show user's position on map:
- Add blue marker to `/components/map/OSMMap.tsx` for user location
- Auto-center map on user location when activated
- Differentiate visually from location markers

### 6. Test the feature
Verify functionality:
- Test geolocation permission prompt
- Validate distance calculations with known coordinates
- Ensure sorting updates correctly
- Check mobile and desktop UI
- Test error states (permission denied, unavailable)

## Implementation Notes
- **Minimal scope**: Single coordinate retrieval only
- **No persistence**: Don't store location or maintain permissions
- **Simple UI**: One button, clear states
- **Integrate only where needed**: Map detail page only
- **Distance display**: Optional, only show if helpful

## Success Criteria
- ✅ User can click button to request current location
- ✅ Locations sort by distance when user location available
- ✅ Map shows user location marker
- ✅ Error states handled gracefully
- ✅ No over-engineered tracking or persistence
- ✅ Works on mobile and desktop browsers
