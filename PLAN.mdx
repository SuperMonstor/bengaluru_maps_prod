
---

# Feature Implementation Plan

## Feature 1: Google Maps List Import Tool ✅ COMPLETE

### Objective
Allow users to paste a public Google Maps list URL (e.g., `https://maps.app.goo.gl/Kbtbcuqjmhwmvr5NA`) on the create-map page and automatically import all locations from that list into their map.

### Implementation Summary

**Approach: Server-side scraping with signal-based extraction**

**Key Files:**
- `lib/services/googleMapsListService.ts` - URL resolution, HTML parsing, signal-based extraction
- `lib/supabase/api/bulkImportLocationsAction.ts` - Bulk database insertion with deduplication
- `lib/supabase/api/parseGoogleMapsListAction.ts` - Server action wrapper
- `components/map/GoogleMapsListImport.tsx` - UI component with preview mode

**Architecture:**
1. Find `<script>` tag containing location data (anchored by `/g/` patterns)
2. Extract data array using coordinate pattern anchor `[null,null,LAT,LNG]`
3. Unescape and parse as JavaScript using `Function()`
4. Signal-based recursive walk to extract: name, coords, CID
5. CID used as canonical identifier (no Google Places API needed)
6. Deduplication by CID, URL, and coordinates

**Tested:** 79-location list - extracts all locations correctly

### Checkpoints

#### 1.1 Create URL resolution utility ✅
#### 1.2 Build list scraping/parsing service ✅
#### 1.3 Create Google Places matching utility ⏭️ SKIPPED
- Better approach: Use CID directly from scraping
- CID-based URLs (`https://maps.google.com/?cid={cid}`) are more reliable
- No API calls needed, saves cost/quota

#### 1.4 Create bulk import server action ✅
#### 1.5 Build import UI on create-map page ✅
#### 1.6 Testing and edge cases ✅

---

## Feature 2: Add Collaborators

### Objective
Allow map creators to add other users as collaborators who can add and maintain locations on the map. Include email notifications for invitations.

### Technical Analysis

**Current State:**
- Maps have single `owner_id` - only owner can edit
- No collaborator table exists
- Email system (Resend) already in place
- Authorization checks are application-level in server actions

**New Components Needed:**
- `map_collaborators` database table
- Collaborator management UI (invite, remove)
- Updated permission checks across all relevant actions
- Email templates for invitations

### Checkpoints

#### 2.1 Create database schema for collaborators
- Create `map_collaborators` table:
  ```sql
  - id (UUID, primary key)
  - map_id (UUID, FK to maps)
  - user_id (UUID, FK to users, nullable for pending invites)
  - email (string, for pending invites)
  - role ('editor' | 'viewer')
  - status ('pending' | 'accepted' | 'declined')
  - invited_by (UUID, FK to users)
  - created_at, updated_at
  ```
- Add RLS policies for security
- Create TypeScript types in `lib/types/mapTypes.ts`

#### 2.2 Create collaborator service functions
- `addCollaborator(mapId, email, role)` - invite by email
- `removeCollaborator(mapId, collaboratorId)` - remove collaborator
- `getCollaborators(mapId)` - list all collaborators
- `acceptInvitation(invitationId)` - accept invite
- `checkCollaboratorPermission(mapId, userId, permission)` - permission check helper

#### 2.3 Create server actions for collaborator management
- `inviteCollaboratorAction` - sends invite email
- `removeCollaboratorAction` - removes collaborator
- `acceptInvitationAction` - accepts pending invite
- `getCollaboratorsAction` - fetches collaborator list

#### 2.4 Update permission checks across codebase
- Update `updateMapAction` to allow collaborators with edit role
- Update `fetchPendingSubmissionsAction` to allow collaborators
- Update `approveLocationAction` / `rejectLocationAction`
- Update location deletion permissions
- Create shared `hasMapEditPermission(mapId, userId)` helper

#### 2.5 Create email templates for collaborator invitations
- Invitation email template (with accept link)
- Acceptance confirmation email to inviter
- Add to existing `emailService.ts`

#### 2.6 Build collaborator management UI
- Add "Collaborators" section to map edit page
- Email input to invite new collaborators
- List of current collaborators with remove button
- Role selector (editor/viewer)
- Pending invitations display

#### 2.7 Build invitation acceptance flow
- Create `/invitations/[id]/accept` route
- Handle logged-in vs logged-out users
- Link user account to invitation on accept
- Redirect to map after acceptance

#### 2.8 Testing
- Test invitation flow end-to-end
- Verify permission checks work for collaborators
- Test edge cases (invite existing collaborator, remove self, etc.)
- Verify emails are sent correctly

---

## Feature 3: Rename "Contribute" to "Suggest Location" ✅ COMPLETE

### Objective
Replace "Contribute" with clearer terminology for better UX.

### Implementation Summary
- Button text changed from "Contribute a Location" to "Suggest Location"
- "Suggest Location" chosen over "Add Location" as it better conveys the submission/approval workflow

### Checkpoints

#### 3.1 Update UI text ✅
- Changed button label in MapDetailsDialog.tsx to "Suggest Location"

#### 3.2 Documentation Updates (Deferred)
- Documentation updates can be done as needed

---

## Implementation Order

1. **Feature 3: Rename "Contribute"** - Quick win, 5 minutes
2. **Feature 1: Google Maps Import** - Medium complexity, needs research first
3. **Feature 2: Collaborators** - Highest complexity, database changes

---

## Open Questions

### Feature 1 (Google Maps Import)
- [x] ~~Is scraping Google Maps lists feasible/reliable?~~ **Yes, validated**
- [x] ~~Should we consider KML upload as alternative?~~ **No, not user-friendly**
- [ ] Rate limiting for bulk Places API calls - implement delays between calls

### Feature 2 (Collaborators)
- [ ] Should collaborators be able to invite other collaborators?
- [ ] Do we need a "viewer" role or just "editor"?
- [ ] Should there be a limit on number of collaborators?

